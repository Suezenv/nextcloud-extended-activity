{"version":3,"file":"ActivityTab-B1eGa9lV.chunk.mjs","sources":["../src/components/ActivitySidebarPlugin.vue","../src/views/ActivityTab.vue"],"sourcesContent":["<!--\n  - SPDX-FileCopyrightText: 2023 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div ref=\"attachTarget\" />\n</template>\n\n<script setup lang=\"ts\">\nimport type { IActivitySidebarAction } from '../models/ActivityAPI.ts'\n\nimport { getCurrentInstance, onBeforeUnmount, onMounted, ref } from 'vue'\n\nconst props = defineProps<{\n\t/** The sidebar plugin */\n\tplugin: IActivitySidebarAction\n\tfileInfo: object | null\n}>()\n\nconst emit = defineEmits<{\n\t(e: 'reload-activities'): void\n}>()\n\nconst attachTarget = ref<HTMLDivElement>()\n\nonMounted(() => props.plugin.mount(attachTarget.value as HTMLDivElement, {\n\tcontext: getCurrentInstance()?.proxy,\n\tfileInfo: props.fileInfo,\n\treload: () => emit('reload-activities'),\n}))\nonBeforeUnmount(() => props.plugin.unmount())\n</script>\n","<!--\n  - SPDX-FileCopyrightText: 2021 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div\n\t\t:class=\"{ 'icon-loading': loading }\"\n\t\tclass=\"extended_activity\">\n\t\t<!-- error message -->\n\t\t<NcEmptyContent v-if=\"error || fileInfo === null\" :name=\"error\">\n\t\t\t<template #icon>\n\t\t\t\t<NcIconSvgWrapper :svg=\"lightningBoltSVG\" />\n\t\t\t</template>\n\t\t</NcEmptyContent>\n\t\t<template v-else>\n\t\t\t<!-- activities actions -->\n\t\t\t<div v-if=\"sidebarPlugins.length > 0\" class=\"extended_activity__actions\">\n\t\t\t\t<ActivitySidebarPlugin\n\t\t\t\t\tv-for=\"plugin, index of sidebarPlugins\"\n\t\t\t\t\t:key=\"index\"\n\t\t\t\t\t:plugin=\"plugin\"\n\t\t\t\t\t:file-info=\"fileInfo\"\n\t\t\t\t\t@reload-activities=\"getActivities()\" />\n\t\t\t</div>\n\n\t\t\t<!-- activities content -->\n\t\t\t<NcEmptyContent\n\t\t\t\tv-if=\"loading\"\n\t\t\t\tclass=\"extended_activity__empty-content\"\n\t\t\t\t:name=\"t('activity', 'Loading activities')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<NcLoadingIcon />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<NcEmptyContent\n\t\t\t\tv-else-if=\"activities.length === 0\"\n\t\t\t\tclass=\"extended_activity__empty-content\"\n\t\t\t\t:name=\"t('activity', 'No activity yet')\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<span class=\"icon-activity\" />\n\t\t\t\t</template>\n\t\t\t</NcEmptyContent>\n\t\t\t<ul v-else class=\"extended_activity__list\">\n\t\t\t\t<ActivityComponent\n\t\t\t\t\tv-for=\"activity in activities\"\n\t\t\t\t\t:key=\"activity.id\"\n\t\t\t\t\t:activity=\"activity\"\n\t\t\t\t\t:show-previews=\"false\"\n\t\t\t\t\t@reload=\"getActivities()\" />\n\t\t\t</ul>\n\t\t</template>\n\t</div>\n</template>\n\n<script lang='ts'>\nimport type { IActivitySidebarAction, IActivitySidebarEntry } from '../models/ActivityAPI.ts'\n\nimport lightningBoltSVG from '@mdi/svg/svg/lightning-bolt.svg?raw'\nimport axios from '@nextcloud/axios'\nimport { translate as t } from '@nextcloud/l10n'\nimport { generateOcsUrl } from '@nextcloud/router'\nimport { defineComponent, nextTick } from 'vue'\nimport NcEmptyContent from '@nextcloud/vue/components/NcEmptyContent'\nimport NcIconSvgWrapper from '@nextcloud/vue/components/NcIconSvgWrapper'\nimport NcLoadingIcon from '@nextcloud/vue/components/NcLoadingIcon'\nimport ActivityComponent from '../components/ActivityComponent.vue'\nimport ActivitySidebarPlugin from '../components/ActivitySidebarPlugin.vue'\nimport ActivityModel from '../models/ActivityModel.ts'\nimport { getActivityFilters, getAdditionalEntries, getSidebarActions } from '../utils/api.ts'\nimport logger from '../utils/logger.ts'\n\nconst ActivityTab = defineComponent({\n\tname: 'ActivityTab',\n\tcomponents: {\n\t\tActivityComponent,\n\t\tNcEmptyContent,\n\t\tNcIconSvgWrapper,\n\t\tNcLoadingIcon,\n\t\tActivitySidebarPlugin,\n\t},\n\n\texpose: ['update'],\n\n\tdata() {\n\t\treturn {\n\t\t\terror: '',\n\t\t\tloading: true,\n\t\t\tfileInfo: null,\n\t\t\tactivities: [] as (IActivitySidebarEntry | ActivityModel)[],\n\t\t\tlightningBoltSVG,\n\t\t\tsidebarPlugins: [] as IActivitySidebarAction[],\n\t\t}\n\t},\n\n\tmounted() {\n\t\tthis.sidebarPlugins = getSidebarActions()\n\t},\n\n\tmethods: {\n\t\t/**\n\t\t * Update current fileInfo and fetch new activities\n\t\t *\n\t\t * @param fileInfo the current file FileInfo\n\t\t */\n\t\tasync update(fileInfo) {\n\t\t\tthis.sidebarPlugins = []\n\t\t\tconst sidebarPlugins = getSidebarActions()\n\t\t\tif (sidebarPlugins.length > 0) {\n\t\t\t\tnextTick(() => {\n\t\t\t\t\tthis.sidebarPlugins = sidebarPlugins\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tthis.fileInfo = fileInfo\n\t\t\tthis.resetState()\n\t\t\tawait this.getActivities()\n\t\t},\n\n\t\t/**\n\t\t * Get the existing activities\n\t\t */\n\t\tasync getActivities() {\n\t\t\ttry {\n\t\t\t\tthis.loading = true\n\n\t\t\t\tconst activities = await this.processActivities(await this.loadRealActivities())\n\t\t\t\tconst otherEntries = await getAdditionalEntries({ fileInfo: this.fileInfo })\n\t\t\t\tthis.activities = [...activities, ...otherEntries].sort((a, b) => b.timestamp - a.timestamp)\n\t\t\t} catch (error) {\n\t\t\t\tthis.error = t('activity', 'Unable to load the activity list')\n\t\t\t\tlogger.error('Error loading the activity list', { error })\n\t\t\t} finally {\n\t\t\t\tthis.loading = false\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Reset the current view to its default state\n\t\t */\n\t\tresetState() {\n\t\t\tthis.loading = true\n\t\t\tthis.error = ''\n\t\t\tthis.activities = []\n\t\t},\n\n\t\t/**\n\t\t * Load activites from API\n\t\t */\n\t\tasync loadRealActivities() {\n\t\t\ttry {\n\t\t\t\tconst { data } = await axios.get(\n\t\t\t\t\tgenerateOcsUrl('apps/extended_activity/api/v2/activity/filter'),\n\t\t\t\t\t{\n\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\tformat: 'json',\n\t\t\t\t\t\t\tobject_type: 'files',\n\t\t\t\t\t\t\tobject_id: this.fileInfo.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\treturn data.ocs.data\n\t\t\t} catch (error) {\n\t\t\t\t// Status 304 is not an error.\n\t\t\t\tif (error.response !== undefined && error.response.status === 304) {\n\t\t\t\t\treturn []\n\t\t\t\t}\n\t\t\t\tthrow error\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Process the API response activities and apply filter\n\t\t *\n\t\t * @param activities the activites\n\t\t */\n\t\tprocessActivities(activities): ActivityModel[] {\n\t\t\tactivities = activities.map((activity) => new ActivityModel(activity))\n\n\t\t\tlogger.debug(`Processed ${activities.length} activity(ies)`, { activities, fileInfo: this.fileInfo })\n\n\t\t\tconst filters = getActivityFilters()\n\t\t\treturn activities.filter((activity) => !filters || filters.every((filter) => filter(activity)))\n\t\t},\n\n\t\tt,\n\t},\n})\n\nexport default ActivityTab\nexport type ActivityTabType = typeof ActivityTab\n</script>\n\n<style scoped lang=\"scss\">\n.activity {\n\tdisplay: flex;\n\tflex-direction: column;\n\toverflow: hidden;\n\theight: 100%;\n\n\t&__actions {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\twidth: 100%;\n\t}\n\n\t&__list {\n\t\tflex-grow: 1;\n\t\toverflow: scroll;\n\t}\n\n\t&__empty-content {\n\t\theight: 100%;\n\t}\n}\n\n:deep(.empty-content__icon span) {\n\tbackground-size: 64px;\n\twidth: 64px;\n\theight: 64px;\n}\n</style>\n"],"names":["_hoisted_1","_openBlock","_createElementBlock","ActivityTab","t","axios","generateOcsUrl","_normalizeClass","_createCommentVNode","_createBlock","_withCtx","_createVNode","_Fragment","_renderList","_createElementVNode"],"mappings":"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"}